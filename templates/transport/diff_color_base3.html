{% extends "transport/transport_base3.html" %}
{% load static from staticfiles %}
{% block head %}
    <script type="text/javascript" src="{% static "js/echarts3.js" %}"></script>
    {% ifequal data_type 0 %}
        <script type="text/javascript" src="{% static "output/pathpoints_all.js" %}"></script>
    {% else %}
        <script type="text/javascript" src="{% static "output/pathpoints.js" %}"></script>
    {% endifequal %}
    <script>
        var corr_step_now=-1;
        var overlays_to_rm=[];
        var line_points_list=[];
        var tmp_attr_name="";
    </script>
    {% block headscript %}
    {% endblock %}
{% endblock %}
{% block content %}
<div id="map"></div>

<div >
<div class="modal fade" id="myModal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel" >
  <div class="modal-dialog" id="modal_dialog"   role="document" >
    <div class="modal-content" id="modal_content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body" id="modal_body" style="width: 1000px;height:600px;">
        <div id="echart_body" style="width: 1000px;height:600px;">
        </div>
        <div id="modal_inner" style="width: 400px;height:300px;">
            <div class="form-group">
                <label for="delay_time" class="control-label">时间延迟步长(小时):</label>
                <select id="delay_time" class="form-control input-md" name="delay_time">
                    {% for delay in delay_list %}
                        {% ifequal forloop.counter 2 %}
                            <option value="{{ delay }}" selected="selected">{{ delay }}</option>
                        {% else %}
                            <option value="{{ delay }}">{{ delay }}</option>
                        {% endifequal %}
                    {% endfor %}
                </select>
           </div>
            <div class="form-group">
                <label for="delay_cnt" class="control-label">计算延迟数量(次):</label>
                <select id="delay_cnt" class="form-control input-md" name="delay_time">
                    {% for delay_no in delay_times %}
                        {% ifequal forloop.counter 1 %}
                            <option value="{{ delay_no }}" selected="selected">{{ delay_no }}</option>
                        {% else %}
                            <option value="{{ delay_no }}">{{ delay_no }}</option>
                        {% endifequal %}
                    {% endfor %}
                </select>
           </div>
            <div class="form-group">
                <button onclick="delay_submit()" class="btn btn-success">确定</button>
                <button onclick="cancel_delay_submit()" class="btn btn-default">取消</button>
           </div>
        </div>
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>
</div>
{% block endscript %}
{% endblock %}
<script type="text/javascript" >
    function reset_corr()
    {
        corr_step_now=-1;
        overlays_to_rm=[];
        line_points_list=[];
    }
    function multi_region_corr(div,corr_btn,selected_done,drop_ul)
    {
        div.removeChild(corr_btn);
        div.appendChild(selected_done);
        drop_ul.style.visibility="hidden";
        alert("请您依次选择区域,单击左上角[选好了]按钮完成多区域选取!");
        reset_corr();
        corr_step_now=0;
    }
    function time_delay(drop_ul)
    {
        drop_ul.style.visibility="hidden";
        alert("请您选择要进行时滞相关分析的区域!");
        reset_corr();
        corr_step_now=-2;
    }
    function cancel_delay_submit()
    {
        myModal.modal('hide');
        myModal.css("height", "600px");
        myModal.css("weight", "1100px");
        modal_dialog.css("height", "600px");
        modal_dialog.css("weight", "1100px");
        echart_body.css("height", "600px");
        echart_body.css("weight", "1100px");
        modal_inner.hide();
    }
    function delay_submit()
    {
        var del_time_selected=$("#delay_time option:selected");
        var del_time=del_time_selected.text();

        var del_cnt_selected=$("#delay_cnt option:selected");
        var del_cnt=del_cnt_selected.text();
        tmp_attr_name="delay";
        var points_lst=line_points_list[0];
        $.ajaxSetup({
            dataType: "json",
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
        });

        var json_points = JSON.stringify(points_lst);
        $.ajax({
            type: "POST",
            url: "/transport/area_statistics?"+"data_type=1&point_type={{ data_type }}"+"&del_time="+del_time+"&del_cnt="+del_cnt+"&region_type="+tmp_attr_name,
            data: {point_list: json_points},
            success: function (result) {
                if (result.code == 0) {
                    handle_result_from_json(result);
                }
            else {
                alert(result.message);
            }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.table([{
                    "错误类型": jqXHR,
                    "错误信息": textStatus,
                    "http状态": errorThrown
                }])
            }
        });
        for(var l=0;l<overlays_to_rm.length;l++)
        {
            map.removeOverlay(overlays_to_rm[l]);
        }
        overlays_to_rm=[];
        //reset_corr();
    }
    function area_selection(points_list,overlays_tmp)
    {
        $.confirm({
                        confirmButtonClass: 'btn-info',
                        cancelButtonClass: 'btn-danger',

                        keyboardEnabled: true,
                        title: '信息',
                        content: '是否选择当前区域中的数据点?',
                        confirmButton: '是',
                        cancelButton: '否',
                        closeIcon: true,
                        confirm: function () {

                            $.ajaxSetup({
                                dataType: "json",
                                beforeSend: function (xhr, settings) {
                                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                                },
                            });

                            var json_points = JSON.stringify(points_list);
                            $.ajax({
                                type: "POST",
                                url: "/transport/area_statistics?"+"data_type=1&point_type={{ data_type }}&region_type="+tmp_attr_name,
                                data: {point_list: json_points},
                                success: function (result) {
                                    if (result.code == 0) {
                                    handle_result_from_json(result);
                                }
                                else {
                                    alert(result.message);
                                }
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    console.table([{
                                        "错误类型": jqXHR,
                                        "错误信息": textStatus,
                                        "http状态": errorThrown
                                    }])
                                }
                            });
                            for(var l=0;l<overlays_tmp.length;l++)
                            {
                                map.removeOverlay(overlays_tmp[l]);
                            }
                        },
                        cancel: function () {
                           for(var l=0;l<overlays_tmp.length;l++)
                            {
                                map.removeOverlay(overlays_tmp[l]);
                            }
                        }
                    });
    }
    function select_an_area(now_overlay,line_points,modal_in)
    {
        if (corr_step_now==-1)//普通模式
        {
            overlays_to_rm.push(now_overlay);
            tmp_attr_name="single";
            area_selection(line_points,overlays_to_rm);
            overlays_to_rm=[];
        }
        else if (corr_step_now==-2)
        {
            //时滞相关性分析,根据形状发送至后台数据
            overlays_to_rm.push(now_overlay);

            line_points_list.push(line_points);
            //弹出设置框
            myModal.css("height", "300px");
            myModal.css("weight", "300px");
            modal_dialog.css("height", "300px");
            modal_dialog.css("weight", "300px");
            echart_body.css("height", "300px");
            echart_body.css("weight", "300px");
            echart_body.hide();
            modal_in.show();
            myModal.modal('show');
        }
        else
        {
            //多区域相关性分析
            overlays_to_rm.push(now_overlay);
            line_points_list.push(line_points);
        }
    }
    function i_selected_done(div,corr_btn,selected_done,drop_ul)
    {
        tmp_attr_name="multi";
        area_selection(line_points_list,overlays_to_rm);
        reset_corr();
        div.removeChild(selected_done);
        div.appendChild(corr_btn);
        drop_ul.style.visibility="visible";
        reset_corr();
    }
    //百度地图相关代码
    var myModal=$('#myModal');
    var mapDiv=$("#map");
    var map = new BMap.Map("map", {});                        // 创建Map实例
    map.centerAndZoom(new BMap.Point(116.404, 39.915), 12);     // 初始化地图,设置中心点坐标和地图级别
    map.enableScrollWheelZoom(true);                        //启用滚轮放大缩小
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});// 左上角，添加比例尺
	var top_left_navigation = new BMap.NavigationControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});  //左上角，添加默认缩放平移控件
    map.addControl(top_left_control);
    map.addControl(top_left_navigation);
    // 定义一个控件类,即function
	function CorrControl(){
	  // 默认停靠位置和偏移量
	  this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
	  this.defaultOffset = new BMap.Size(10, 10);
	}

    // 通过JavaScript的prototype属性继承于BMap.Control
    CorrControl.prototype = new BMap.Control();

    // 自定义控件必须实现自己的initialize方法,并且将控件的DOM元素返回
    // 在本方法中创建个div元素作为控件的容器,并将其添加到地图容器中
    CorrControl.prototype.initialize = function(map){
      // 创建一个DOM元素
      //var div = $('<div class="btn-group" role="group"></div>');
      //var btn=$('<button type="button" class="btn btn-default">1</button>');
      var div = document.createElement("div");
      div.setAttribute('class','btn-group');
      div.setAttribute('role','group');

      var btn_normal = document.createElement("button");
      btn_normal.setAttribute('class','btn btn-primary');
      btn_normal.innerText="普通模式";
      btn_normal.onclick = function(e){
        reset_corr();
      };
      div.appendChild(btn_normal);

      var span_drop = document.createElement("span");
      span_drop.setAttribute('class','caret');

      var btn_corr = document.createElement("button");
      btn_corr.setAttribute('class','btn btn-success dropdown-toggle');
      btn_corr.innerText="相关分析";
      btn_corr.setAttribute('data-toggle','dropdown');
      btn_corr.setAttribute('aria-expanded','false');
      btn_corr.setAttribute('aria-haspopup','true');
      btn_corr.appendChild(span_drop);

      var selected_done = document.createElement("button");
      selected_done.setAttribute('class','btn btn-danger');
      selected_done.innerText="选好了";
      selected_done.onclick=function(e){
          i_selected_done(div,btn_corr,selected_done,drop_ul)
      };
      var drop_ul=document.createElement("ul");//创建ul
      drop_ul.setAttribute('class','dropdown-menu');

      var li_region= document.createElement("li");
      var href_region = document.createElement("a");
      href_region.innerHTML ="多区域相关性分析";
      href_region.href="javascript:void(0);";
      href_region.onclick= function(e){
        multi_region_corr(div,btn_corr,selected_done,drop_ul);
        return false;
      };
      li_region.appendChild(href_region);
      drop_ul.appendChild(li_region);

      var li_delay= document.createElement("li");
      var href_delay = document.createElement("a");
      href_delay.innerHTML ="时滞相关性分析";
      href_delay.href="javascript:void(0);";
      href_delay.onclick= function(e){
        time_delay(drop_ul);
        return false;
      };
      li_delay.appendChild(href_delay);
      drop_ul.appendChild(li_delay);
      // 添加文字说明
      div.appendChild(btn_corr);
      div.appendChild(drop_ul);

      // 添加DOM元素到地图中
      map.getContainer().appendChild(div);
      // 将DOM元素返回
      return div;
    };
    // 创建控件
    var myCtrl = new CorrControl();
	// 添加到地图当中
	map.addControl(myCtrl);

    var noise_invisible={{ noise_invisible }};
    if (document.createElement('canvas').getContext) {  // 判断当前浏览器是否支持绘制海量点
        var points1 = [],points2 = [],points3 = [];  // 添加海量点数据
        label_index=3;
        {% ifequal data_type 0 %}
            path_data=pathpoints.data;
        {% else %}
            path_data=pathpoints.data[{{ data_type }}-1];
        {% endifequal %}
        for (var i = 0; i < path_data.length; i++) {
            if(path_data[i][label_index]==1){
                points1.push(new BMap.Point(path_data[i][0], path_data[i][1]));
            }else if(path_data[i][label_index]==-1) {
                points2.push(new BMap.Point(path_data[i][0], path_data[i][1]));
            }else {
                points3.push(new BMap.Point(path_data[i][0], path_data[i][1]));
            }
        }
        var options1 = {
            //size: BMAP_POINT_SIZE_TINY,
            size: BMAP_POINT_SIZE_SMALLER,
            //shape: BMAP_POINT_SHAPE_STAR,
            color: '#ff0000'
        };
        var options2 = {
            //size: BMAP_POINT_SIZE_TINY,
            size: BMAP_POINT_SIZE_SMALLER,
            //shape: BMAP_POINT_SHAPE_STAR,
            color: '#0000ff'
        };
        var options3 = {
            //size: BMAP_POINT_SIZE_TINY,
            size: BMAP_POINT_SIZE_SMALLER,
            //shape: BMAP_POINT_SHAPE_STAR,
            color: '#000000'
        };
        var pointCollection1 = new BMap.PointCollection(points1, options1);  // 初始化PointCollection
        var pointCollection2 = new BMap.PointCollection(points2, options2);  // 初始化PointCollection
        var pointCollection3 = new BMap.PointCollection(points3, options3);  // 初始化PointCollection

        map.addOverlay(pointCollection1);  // 添加Overlay
        map.addOverlay(pointCollection2);  // 添加Overlay
        if (noise_invisible==0) {
            map.addOverlay(pointCollection3);  // 添加Overlay
        }
    } else {
        alert('请在chrome、safari、IE8+以上浏览器查看本示例');
    }
    var overlays = [];

    var overlaycomplete = function(e){
        if (e.drawingMode=="polyline")//如果是画多边形结束后
        {
            var line_points = e.overlay.ia;
            poly_start_point=line_points[0];
            poly_end_point=line_points[line_points.length-1];
            distance_of_st=distance(poly_start_point,poly_end_point);
            threshold=0.0022;
            if (distance_of_st <= threshold)
            {

                now_overlay= e.overlay;
                select_an_area(now_overlay,line_points,modal_inner);
            }
            else {
                $.confirm({
                confirmButtonClass: 'btn-info',
                cancelButtonClass: 'btn-default',

                keyboardEnabled: true,
                title: '警告',
                content: '选择的区域起点和终点应相同,请重新绘制!',
                confirmButton: '确定',
                cancelButton: '取消',
                closeIcon: true,
                confirm: function () {
                    map.removeOverlay(e.overlay);
                },
                cancel: function () {
                    map.removeOverlay(e.overlay);
                }
            });
            }
        }
        if (e.drawingMode=="rectangle") {//画矩形结束
            var olRectPoint = e.overlay.ro;
            /* *.Nk是从 e 的dom节点中寻找到的，百度本身没有提供此方法的介绍。
             * olRectPoint坐标排序方式
             *	┌─────────────────────┐
             *	│0					1 │
             *	│					  │
             *	│3					2 │
             *	└─────────────────────┘
             * */
            var sw = olRectPoint[0];		//左上
            var ne = olRectPoint[2];		//右下
            //alert('左上：'+ sw.lng+',' + sw.lat + '    右下：'+ne.lng+','+ne.lat);
            var line_points2=[sw,ne];
            var now_overlay= e.overlay;
            select_an_area(now_overlay,line_points2,modal_inner);
        }
    };
    var styleOptions = {
        strokeColor:"blue",    //边线颜色。
        fillColor:"blue",      //填充颜色。当参数为空时，圆形将没有填充效果。
        strokeWeight: 3,       //边线的宽度，以像素为单位。
        strokeOpacity: 0.5,	   //边线透明度，取值范围0 - 1。
        fillOpacity: 0.2,      //填充的透明度，取值范围0 - 1。
        strokeStyle: 'solid' //边线的样式，solid或dashed。
    };
    //实例化鼠标绘制工具
    var drawingManager = new BMapLib.DrawingManager(map, {
        isOpen: false, //是否开启绘制模式
        enableDrawingTool: true, //是否显示工具栏
        drawingToolOptions: {
            anchor: BMAP_ANCHOR_TOP_RIGHT, //位置
            offset: new BMap.Size(5, 5), //偏离值
        },
        circleOptions: styleOptions, //圆的样式
        polylineOptions: styleOptions, //线的样式
        polygonOptions: styleOptions, //多边形的样式
        rectangleOptions: styleOptions //矩形的样式
    });
	 //添加鼠标绘制工具监听事件，用于获取绘制结果
    drawingManager.addEventListener('overlaycomplete', overlaycomplete);
    function clearAll() {
		for(var i = 0; i < overlays.length; i++){
            map.removeOverlay(overlays[i]);
        }
        overlays.length = 0
    }

    function distance(x,y){
        lat_sqr=Math.pow((x.lat- y.lat),2);
        lng_sqr=Math.pow((x.lng- y.lng),2);
        return Math.sqrt(lat_sqr+lng_sqr);
    }

</script>
{% endblock %}
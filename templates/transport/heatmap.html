{% load static from staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE9" />
    <title>{% block title %}{% endblock %}</title>
    <style type="text/css">
        html,body{
            margin:0;
            width:100%;
            height:100%;
            background:#ffffff;
        }
        #map{
            width:100%;
            height:95%;
        }
        #modal_dialog{
            width:300px;
            height:300px;
        }


        #navi{
            width:100%;
            height:5%;
        }
        #panel {
            position: absolute;
            top:30px;
            left:10px;
            z-index: 999;
            color: #fff;
        }
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=eM0GfCwd27kZRyM49ZOkvkOaidDXz6Wf"></script>
    <link rel="stylesheet" href="{% static "css/DrawingManager_min.css" %}" />
    <script type="text/javascript" src="{% static "js/jquery-1.11.3.min.js" %}"></script>
    <link rel="stylesheet" type="text/css" media="screen" href="{% static "css/bootstrap.min.css" %}" />
    <script type="text/javascript" src="{% static "js/bootstrap.min.js" %}" charset="UTF-8"></script>
    <link rel="stylesheet" type="text/css" media="screen" href="{% static "css/font-awesome.css" %}" />
    <link rel="stylesheet" href="{% static "css/awesome-bootstrap-checkbox.css" %}" />
    <link rel="stylesheet" type="text/css" media="screen" href="{% static "css/jquery-confirm.min.css" %}" />
    <script type="text/javascript" src="{% static "js/jquery-confirm.min.js" %}" charset="UTF-8"></script>
    <script type="text/javascript" src="{% static "js/DrawingManager_min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/DrawingManager_min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/echarts3.js" %}"></script>
    {% ifnotequal month -1 %}
        <script type="text/javascript" src="{{ path_load_js_file }}"></script>
    {% endifnotequal %}
    <script type="text/javascript" src="{% static "js/echarts3.js" %}"></script>
<script type="text/javascript" src="{% static "js/Heatmap_min.js" %}"></script>
    <script type="text/javascript">
    var myChart;
    var myModal=$('#myModal');
    var modal_body = $("#modal_body");
    function close_modal()
    {
        $("#modal_inner").css('display','block');
        $("#echart_body").css('display','none');
        $("#btn_submit").show();
        $('#myModal').modal('hide');
    }

    function submit_modal()
    {
        var month = $("#month option:selected").val();
        var region_name = $("#region_name option:selected").val();
        var week_aggregate = $("#week_aggregate option:selected").val();
        $.ajaxSetup({
            dataType: "json",
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            }
        });

        $.ajax({
            type: "GET",
            url: "/transport/violation_statistics?region_name="+region_name +"&week_aggregate="+week_aggregate+"&month="+month,
            success: function (result) {
                if (result.code == 0) {
                    var addr=result.message;
                    if(typeof addr != "object"){
                        $.get(addr).done(function (rtn_json) {
                            $("#modal_inner").css('display','none');
                            $("#echart_body").css('display','block');
                            $("#btn_submit").hide();
                            myChart.setOption(rtn_json);

                        });
                    }
                    else
                    {
                        return "返回的数据格式不对!";
                    }
                }
            else {
                alert(result.message);
            }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.table([{
                    "错误类型": jqXHR,
                    "错误信息": textStatus,
                    "http状态": errorThrown
                }])
            }
        });
    }

    </script>
    {% block head %}{% endblock %}
</head>

<body>
    {% block navigator %}
        <nav class="navbar navbar-default" style="margin-bottom:0" id ="navi">
          <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="{% url 'transport:heatmap' %}">北京App违法举报</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav">
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">月份<span class="caret"></span></a>
                  <ul class="dropdown-menu">
                    <li><a href="{% url 'transport:heatmap' %}?month=0">全部</a></li>
                      {% for month_i in months %}
                        <li><a href="{% url 'transport:heatmap' %}?month={{ month_i }}">{{ month_i }}月</a></li>
                    {% endfor %}
                  </ul>
                </li>
                  <li>
                      <a href="javascript:void(0);" data-toggle="modal" data-target="#myModal">App举报统计</a>
                  </li>
              </ul>
            </div><!-- /.navbar-collapse -->
          </div><!-- /.container-fluid -->
        </nav>
    {% endblock %}
    <div id="map">

    </div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="width: 1440px;height:800px;">
	<div class="modal-dialog" id="modal_dialog" style="width: 1440px;height:800px;">
		<div class="modal-content" id = "modal_content" style="width: 1440px;height:800px;">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
					&times;
				</button>
			</div>
			<div class="modal-body" id="modal_body"  style="width: 1440px;height:700px;">
                <div id="echart_body" style="width: 1440px;height:700px;display: none">

                </div>
            <div id="modal_inner">
                    <div class="form-group">
                    <label for="month" class="control-label">月份</label>
                    <select id="month" class="form-control input-md" name="month">
                        {% for month_i in months %}
                             {% ifequal forloop.counter 1 %}
                                 <option value="{{ month_i }}" selected="selected">{{ month_i }}月</option>
                            {% else %}
                                <option value="{{ month_i }}">{{ month_i }}月</option>
                            {% endifequal %}
                        {% endfor %}
                    </select>
                   </div>
                    <div class="form-group">
                        <label for="region_name" class="control-label">区域</label>
                        <select id="region_name" class="form-control input-md" name="region_name">
                            {% for region_name_i in region_names %}
                                {% ifequal forloop.counter 1 %}
                                    <option value="{{ region_name_i }}" selected="selected">{{ region_name_i }}</option>
                                {% else %}
                                    <option value="{{ region_name_i }}">{{ region_name_i }}</option>
                                {% endifequal %}
                            {% endfor %}
                        </select>
                   </div>
                    <div class="form-group">
                        <label for="week_aggregate" class="control-label">星期聚合</label>
                        <select id="week_aggregate" class="form-control input-md" name="week_aggregate">
                            <option value="0" selected="selected">否</option>
                            <option value="1">是</option>
                        </select>
                   </div>
                </div>
                <div class="form-group">
                <button type="button" class="btn btn-default" onclick="close_modal()">关闭
				</button>
				<button type="button" class="btn btn-primary" id="btn_submit" onclick="submit_modal()">
					提交
				</button>
            </div>
            </div>

			<div class="modal-footer">

			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal -->
</div>
    <script type="text/javascript" >
    {% ifequal month -1 %}
        var points =[];
    {% endifequal %}
    </script>
    <script type="text/javascript" >
    myChart = echarts.init(document.getElementById('echart_body'));
    var mapDiv=$("#map");
    var map = new BMap.Map("map", {});                        // 创建Map实例
    map.centerAndZoom(new BMap.Point(116.404, 39.915), 12);     // 初始化地图,设置中心点坐标和地图级别
    map.enableScrollWheelZoom(true);                        //启用滚轮放大缩小
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});// 左上角，添加比例尺
	var top_left_navigation = new BMap.NavigationControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});  //左上角，添加默认缩放平移控件
    map.addControl(top_left_control);
    map.addControl(top_left_navigation);
    if(!isSupportCanvas()){
    	alert('热力图目前只支持有canvas支持的浏览器,您所使用的浏览器不能使用热力图功能~')
    }
	//详细的参数,可以查看heatmap.js的文档 https://github.com/pa7/heatmap.js/blob/master/README.md
	//参数说明如下:
	/* visible 热力图是否显示,默认为true
     * opacity 热力的透明度,1-100
     * radius 势力图的每个点的半径大小
     * gradient  {JSON} 热力图的渐变区间 . gradient如下所示
     *	{
			.2:'rgb(0, 255, 255)',
			.5:'rgb(0, 110, 255)',
			.8:'rgb(100, 0, 255)'
		}
		其中 key 表示插值的位置, 0~1.
		    value 为颜色值.
     */
	heatmapOverlay = new BMapLib.HeatmapOverlay({"radius":10});
	map.addOverlay(heatmapOverlay);

	heatmapOverlay.setDataSet({data:points,max:50});
	//是否显示热力图
    function openHeatmap(){
        heatmapOverlay.show();
    }
	function closeHeatmap(){
        heatmapOverlay.hide();
    }
{#	closeHeatmap();#}

    function setGradient(){
     	/*格式如下所示:
		{
	  		0:'rgb(102, 255, 0)',
	 	 	.5:'rgb(255, 170, 0)',
		  	1:'rgb(255, 0, 0)'
		}*/
     	var gradient = {};
     	var colors = document.querySelectorAll("input[type='color']");
     	colors = [].slice.call(colors,0);
     	colors.forEach(function(ele){
			gradient[ele.getAttribute("data-key")] = ele.value;
     	});
        heatmapOverlay.setOptions({"gradient":gradient});
    }
    //判断浏览区是否支持canvas
    function isSupportCanvas(){
        var elem = document.createElement('canvas');
        return !!(elem.getContext && elem.getContext('2d'));
    }
    </script>
</body>
</html>
